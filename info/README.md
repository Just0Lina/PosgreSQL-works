# Info21 v1.0

Анализ и статистика данных по школе 21.

## Logical view of database model

![SQL2](./misc/images/SQL2.png)

*Все поля при описании таблиц перечислены в том же порядке, что и на схеме.*

#### Таблица peers

- Ник пира
- День рождения

#### Таблица Tasks

- Название задания
- Название задания, являющегося условием входа
- Максимальное количество XP

Чтобы получить доступ к заданию, нужно выполнить задание, являющееся его условием входа.
Для упрощения будем считать, что у каждого задания всего одно условие входа.
В таблице должно быть одно задание, у которого нет условия входа (т.е. поле parentTask равно null).

#### Статус проверки

Создать тип перечисления для статуса проверки, содержащий следующие значения:
- Start - начало проверки
- Success - успешное окончание проверки
- Failure - неудачное окончание проверки

#### Таблица P2P

- id
- id проверки
- Ник проверяющего пира
- [Статус P2P проверки](#статус-проверки)
- Время

Каждая P2P проверка состоит из 2-х записей в таблице: первая имеет статус начало, вторая - успех или неуспех. \
В таблице не может быть больше одной незавершенной P2P проверки, относящейся к конкретному заданию, пиру и проверяющему. \
Каждая P2P проверка (т.е. обе записи, из которых она состоит) ссылается на проверку в таблице Checks, к которой она относится.


#### Таблица Verter

- id
- id проверки
- [Статус проверки Verter'ом](#статус-проверки)
- Время 

Каждая проверка Verter'ом состоит из 2-х записей в таблице: первая имеет статус начало, вторая - успех или неуспех. \
Каждая проверка Verter'ом (т.е. обе записи, из которых она состоит) ссылается на проверку в таблице Checks, к которой она относится. \
Проверка Verter'ом может ссылаться только на те проверки в таблице Checks, которые уже включают в себя успешную P2P проверку.

#### Таблица Checks

- id
- Ник пира
- Название задания
- Дата проверки

Описывает проверку задания в целом. Проверка обязательно включает в себя **один** этап P2P и, возможно, этап Verter.
Для упрощения будем считать, что пир ту пир и автотесты, относящиеся к одной проверке, всегда происходят в один день.

Проверка считается успешной, если соответствующий P2P этап успешен, а этап Verter успешен, либо отсутствует.
Проверка считается неуспешной, хоть один из этапов неуспешен.
То есть проверки, в которых ещё не завершился этап P2P, или этап P2P успешен, но ещё не завершился этап Verter, не относятся ни к успешным, ни к неуспешным.

#### Таблица TransferredPoints

- id
- Ник проверяющего пира
- Ник проверяемого пира
- Количество переданных пир поинтов за всё время (только от проверяемого к проверяющему)

При каждой P2P проверке проверяемый пир передаёт один пир поинт проверяющему.
Эта таблица содержит все пары проверяемый-проверяющий и кол-во переданных пир поинтов, то есть, 
другими словами, количество P2P проверок указанного проверяемого пира, данным проверяющим.

#### Таблица Friends

- id
- Ник первого пира
- Ник второго пира 

Дружба взаимная, т.е. первый пир является другом второго, а второй -- другом первого.

#### Таблица Recommendations

- id
- Ник пира
- Ник пира, к которому рекомендуют идти на проверку

Каждому может понравиться, как проходила P2P проверка у того или иного пира. 
Пир, указанный в поле peer, рекомендует проходить P2P проверку у пира из поля Recommendedpeer.
Каждый пир может рекомендовать как ни одного, так и сразу несколько проверяющих.

#### Таблица XP

- id
- id проверки
- Количество полученного XP

За каждую успешную проверку пир, выполнивший задание, получает какое-то количество XP, отображаемое в этой таблице. 
Количество XP не может превышать максимальное доступное для проверяемой задачи. 
Первое поле этой таблицы может ссылаться только на успешные проверки.

#### Таблица TimeTracking

- id
- Ник пира
- Дата
- Время
- Состояние (1 - пришел, 2 - вышел)



## Chapter III

## Part 1. Создание базы данных

Написан скрипт *part1.sql*, создающий базу данных и все таблицы, описанные выше. 

Также внесены в скрипт процедуры, позволяющие импортировать и экспортировать данные для каждой таблицы из файла/в файл с расширением *.csv*. \
В качестве параметра каждой процедуры указывается разделитель *csv* файла.

В каждую из таблиц внесены как минимум по 5 записей. 

## Part 2. Изменение данных

##### 1) Написана процедуру добавления P2P проверки

##### 2) Написана процедуру добавления проверки Verter'ом

##### 3) Написан триггер: после добавления записи со статутом "начало" в таблицу P2P, изменить соответствующую запись в таблице TransferredPoints

##### 4) Написан триггер: перед добавлением записи в таблицу XP, проверить корректность добавляемой записи

## Part 3. Получение данных

##### 1) Написана функция, возвращающую таблицу TransferredPoints в более человекочитаемом виде

##### 2) Написана функция, которая возвращает таблицу вида: ник пользователя, название проверенного задания, кол-во полученного XP

##### 3) Написана функция, определяющую пиров, которые не выходили из кампуса в течение всего дня

##### 4) Найден процент успешных и неуспешных проверок за всё время

##### 5) Посчитать изменение в количестве пир поинтов каждого пира по таблице TransferredPoints


##### 6) Посчитаны изменения в количестве пир поинтов каждого пира по таблице, возвращаемой [первой функцией из Part 3]

##### 7)  Определено самое часто проверяемое задание за каждый день


##### 8)  Определена длительность последней P2P проверки


##### 9) Найти всех пиров, выполнивших весь заданный блок задач и дату завершения последнего задания


##### 10)  Определено, к какому пиру стоит идти на проверку каждому обучающемуся


##### 11)  Определен процент пиров, которые:


##### 12)  Определено *N* пиров с наибольшим числом друзей


##### 13)  Определен процент пиров, которые когда-либо успешно проходили проверку в свой день рождения


##### 14)  Определено кол-во XP, полученное в сумме каждым пиром


##### 15)  Определены всех пиры, которые сдали заданные задания 1 и 2, но не сдали задание 3


##### 16) Используя рекурсивное обобщенное табличное выражение, для каждой задачи вывести кол-во предшествующих ей задач


##### 17) Найдены "удачные" для проверок дни. День считается "удачным", если в нем есть хотя бы *N* идущих подряд успешных проверки


##### 18) Определен пир с наибольшим числом выполненных заданий


##### 19) Определен пир с наибольшим количеством XP

##### 20) Определен пир, который провел сегодня в кампусе больше всего времени

##### 21)  Определены пиры, приходивших раньше заданного времени не менее *N* раз за всё время


##### 22)  Определены пиры, выходивших за последние *N* дней из кампуса больше *M* раз


##### 23) Определен пир, который пришел сегодня последним

##### 24)  Определены пиры, которые выходили вчера из кампуса больше чем на *N* минут


##### 25)  Определен для каждого месяца процент ранних входов


Пример вывода:
| Month    | EarlyEntries |  
| -------- | -------------- |
| January  | 15           |
| February | 35           |
| March    | 45           |
